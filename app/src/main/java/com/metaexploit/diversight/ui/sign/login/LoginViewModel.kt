package com.metaexploit.diversight.ui.sign.login

import android.content.Context
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.ViewModel
import com.google.gson.Gson
import com.metaexploit.diversight.R
import com.metaexploit.diversight.remote.DiversightService
import com.metaexploit.diversight.remote.User
import com.metaexploit.diversight.remote.request.LoginRequest
import com.metaexploit.diversight.ui.sign.SignViewModel
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import retrofit2.Response
import timber.log.Timber

class LoginViewModel: ViewModel() {

    fun login(viewModel: SignViewModel, email: String, password: String, context: FragmentActivity, activity: () -> Unit) {
        CoroutineScope(Dispatchers.Main).launch {
            val response = DiversightService.newInstance().login(
                LoginRequest(
                    email = email,
                    password = password
                )
            )
            viewModel.setLoading()
            handleLogin(response, context, activity)
        }
    }

    private fun handleLogin(response: Response<User>, context: FragmentActivity, activity: () -> Unit) {
        if (response.isSuccessful) {
            Timber.d("JOOJ ${response.body()}")
            when (response.body()?.message) {
                "Senha Incorreta" -> {}
                "Colaborador Nao Encontrado" -> {}
                else -> {
                    val user = Gson().toJson(response.body())
                    setUser(user, context)
                    activity()
                }
            }
        }
    }

    private fun setUser(user: String, context: FragmentActivity) {
        val sharedPref = context.getSharedPreferences(context.getString(R.string.id_shared_pref), Context.MODE_PRIVATE) ?: return
        with (sharedPref.edit()) {
            putString(context.getString(R.string.id_user), user)
            commit()
        }
    }
}