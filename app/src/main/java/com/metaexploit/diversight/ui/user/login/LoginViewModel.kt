package com.metaexploit.diversight.ui.user.login

import android.content.Context
import androidx.fragment.app.FragmentActivity
import androidx.lifecycle.ViewModel
import com.google.gson.Gson
import com.metaexploit.diversight.R
import com.metaexploit.diversight.remote.DiversightService
import com.metaexploit.diversight.remote.User
import com.metaexploit.diversight.remote.request.LoginRequest
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import retrofit2.Response

class LoginViewModel: ViewModel() {

    fun login(email: String = "samilly@ioasys.com", password: String = "123", context: FragmentActivity, activity: () -> Unit) {
        CoroutineScope(Dispatchers.Main).launch {
            val response = DiversightService.newInstance().login(
                LoginRequest(
                    email = email,
                    password = password
                )
            )
            handleLogin(response, context, activity)
        }
    }

    private fun handleLogin(response: Response<User>, context: FragmentActivity, activity: () -> Unit) {
        if (response.isSuccessful) {
            val user = Gson().toJson(response.body())
            setUser(user, context, activity)
        }
    }

    private fun setUser(user: String, context: FragmentActivity, activity: () -> Unit) {
        val sharedPref = context.getSharedPreferences(context.getString(R.string.id_shared_pref), Context.MODE_PRIVATE) ?: return
        with (sharedPref.edit()) {
            putString(context.getString(R.string.id_user), user)
            commit()
        }
        activity()
    }
}